# Optimize N+1 queries across API controllers + add BookingResource + local query logging

## Summary
This PR addresses multiple N+1 query issues that were degrading performance across several endpoints. It introduces targeted eager loading, aggregate queries for analytics, an API Resource for bookings to control payload shape, and a local-only query logger to help verify and monitor query counts during development.

## Changes
- FavoriteController@index
  - Fetch and group favorites in a single query using groupBy + pluck instead of manual loops.
- BookingController
  - myIndex: Eager load offering + provider + user with selected columns; return BookingResource collection for consistent, lean payloads.
  - show: Eager load offering, provider, and user with selected columns.
  - providerIndex: Eager load offering and user with selected columns; optimized whereHas.
  - adminIndex: Eager load offering, provider, and user; added per_page validation and filter.
- NotificationController@index
  - Validate inputs and compute unread_count using the already-loaded unread collection when filtering unread to avoid an extra count() query.
- OfferingController@index
  - Eager load place with selected columns (id,title,slug,city). Kept whereHas('place') for city filtering while avoiding N+1.
- ProviderOfferingController@analytics
  - Replace multiple queries with two aggregate queries (offerings summary and bookings summary via join + SUM(CASE...)).
- Booking model
  - Confirmed default eager loading with protected $with = ['user','offering'] (already present) to reduce N+1 across the app.
- BookingResource
  - Introduced App\Http\Resources\BookingResource to shape booking payloads and avoid traversing relations repeatedly.
- AppServiceProvider + logging config
  - Add a local-only DB::listen query logger writing to a dedicated queries channel (storage/logs/queries.log). Added the queries channel in config/logging.php.

## Why
- Reduce query counts on list endpoints (e.g., bookings, offerings) which can balloon under pagination.
- Make payloads predictable and smaller via Resource.
- Provide visibility on queries locally to spot regressions.

## Impact
- Performance: Fewer queries per request; measurable improvements expected on pages returning 20–50 items.
- API shape:
  - BookingController@myIndex now returns a Resource collection. When used with a paginator, it includes standard pagination meta and links according to Laravel Resources conventions. If the client expects the previous custom envelope, we can add a wrapper or adapt the frontend; otherwise this should be compatible with standard resource usage in the project.
- Analytics: ProviderOfferingController analytics response keys have been flattened: offerings_count, published_count, total_bookings, confirmed_bookings, total_revenue, total_commission, net_earnings. If the frontend expects the older nested structure, we can adjust either the response or the client.

## Testing
- Verify endpoints with 50+ results using local env + Debugbar or queries.log:
  - GET /api/v1/bookings (myIndex)
  - GET /api/v1/bookings/{id}
  - GET /api/v1/provider/bookings (providerIndex)
  - GET /api/v1/admin/bookings (adminIndex)
  - GET /api/v1/offerings?city=...
  - GET /api/v1/notifications?unread_only=1
  - GET /api/v1/provider/offerings/analytics
- Confirm significant reduction in total queries and stable response times.

## Notes / Follow-ups
- The Booking model’s $with means relation column constraints in with([...]) may not fully apply. If we want strict control, we can remove or narrow $with and rely on controller-specific eager loading or Resources only.
- If the analytics response shape change is inconvenient, we can provide a backwards-compatible structure or add a new endpoint.

## Files changed (high level)
- app/Http/Controllers/Api/FavoriteController.php
- app/Http/Controllers/Api/BookingController.php
- app/Http/Controllers/Api/NotificationController.php
- app/Http/Controllers/Api/OfferingController.php
- app/Http/Controllers/Api/ProviderOfferingController.php
- app/Http/Resources/BookingResource.php (new)
- app/Providers/AppServiceProvider.php
- config/logging.php



₍ᐢ•(ܫ)•ᐢ₎ Generated by [Capy](https://capy.ai) ([view task](https://capy.ai/project/9df5e817-79df-4a5d-a370-49de473a473e/task/2929cc32-3288-48f1-bf28-5d5a52e30e93))